<?xml version="1.0" encoding="utf-8"?>
<Project InitialTargets="GenerateCodeFirst">
  <PropertyGroup>
    <CodeGenerationOutputPath>$(MSBuildProjectDirectory)\..\bin\CodeGeneration\$(CodeGeneratorConfiguration)\netstandard1.3\</CodeGenerationOutputPath>
  </PropertyGroup>

  <ItemGroup>
    <GeneratorAssemblySearchPaths Include="$(CodeGenerationOutputPath)">
      <Visible>false</Visible>
    </GeneratorAssemblySearchPaths>
  </ItemGroup>
  <ItemGroup>
    <ProjectReference Include="..\CodeGeneration\CodeGeneration.csproj">
      <ReferenceOutputAssembly>false</ReferenceOutputAssembly>
      <SkipGetTargetFrameworkProperties>true</SkipGetTargetFrameworkProperties>
      <UndefineProperties>TargetFramework</UndefineProperties>
      <Properties>Configuration=$(CodeGeneratorConfiguration);Platform=AnyCPU</Properties>
    </ProjectReference>
  </ItemGroup>

  <Target Name="GenerateCodeFirst">
    <PropertyGroup>
      <CoreCompileDependsOn>$(CoreCompileDependsOn);GenerateNativeDllNameCs;GenerateUniqueIdentifierCs</CoreCompileDependsOn>
      <PrepareResourceNamesDependsOn>GenerateCommitIdVersion;$(PrepareResourceNamesDependsOn)</PrepareResourceNamesDependsOn>
      <NativeDllNamePath>$(IntermediateOutputPath)NativeDllName.cs</NativeDllNamePath>
      <UniqueIdentifierPath>$(IntermediateOutputPath)UniqueIdentifier.cs</UniqueIdentifierPath>
      <CommitIdVersionPath>$(IntermediateOutputPath)libgit2sharp_hash.txt</CommitIdVersionPath>
    </PropertyGroup>
  </Target>

  <Target Name="GenerateNativeDllNameCs">
    <ReadLinesFromFile File="@(EmbeddedResource)"
                               Condition=" '%(Filename)%(Extension)' == 'libgit2_filename.txt' ">
      <Output TaskParameter="Lines" PropertyName="libgit2FileName" />
    </ReadLinesFromFile>
    <Message Importance='high' Text='$(libgit2FileName)' />
    <ItemGroup>
      <NativeDllNameSourceLines Include='namespace LibGit2Sharp.Core' />
      <NativeDllNameSourceLines Include='{' />
      <NativeDllNameSourceLines Include='  internal static class NativeDllName' />
      <NativeDllNameSourceLines Include='  {' />
      <NativeDllNameSourceLines Include='    public const string Name = "$(libgit2FileName)"%3b' />
      <NativeDllNameSourceLines Include='  }' />
      <NativeDllNameSourceLines Include='}' />
    </ItemGroup>
    <WriteLinesToFile File="$(NativeDllNamePath)"
                      Lines="@(NativeDllNameSourceLines)"
                      Overwrite="true" />
    <ItemGroup>
      <Compile Include="$(NativeDllNamePath)" />
      <FileWrites Include="$(NativeDllNamePath)" />
    </ItemGroup>
  </Target>

  <!-- This target runs if any of the projects or .cs files for the project have changed since the last time
      the UniqueIdentifier.cs file was generated. -->
  <Target Name="GenerateUniqueIdentifierCs"
           Inputs="$(MSBuildThisFileFullPath);$(MSBuildAllProjects);@(Compile)"
           Outputs="$(UniqueIdentifierPath)">
    <ItemGroup>
      <UniqueIdSourceLines Include='namespace LibGit2Sharp.Core' />
      <UniqueIdSourceLines Include='{' />
      <UniqueIdSourceLines Include='  internal static class UniqueId' />
      <UniqueIdSourceLines Include='  {' />
      <UniqueIdSourceLines Include='    public const string UniqueIdentifier = "$([System.Guid]::NewGuid())"%3b' />
      <UniqueIdSourceLines Include='  }' />
      <UniqueIdSourceLines Include='}' />
    </ItemGroup>

    <WriteLinesToFile File="$(UniqueIdentifierPath)"
                      Lines="@(UniqueIdSourceLines)"
                      Overwrite="true" />

    <ItemGroup>
      <Compile Include="$(UniqueIdentifierPath)" />
      <FileWrites Include="$(UniqueIdentifierPath)" />
    </ItemGroup>
  </Target>

  <Target Name="GenerateCommitIdVersion"
          DependsOnTargets="GetBuildVersion">
    <WriteLinesToFile File="$(CommitIdVersionPath)"
                      Lines="$(GitCommitId)"
                      Overwrite="true" />

    <ItemGroup>
      <EmbeddedResource Include="$(CommitIdVersionPath)">
        <LogicalName>$(RootNamespace).libgit2sharp_hash.txt</LogicalName>
      </EmbeddedResource>
    </ItemGroup>
  </Target>
</Project>
