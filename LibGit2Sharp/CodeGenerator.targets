<?xml version="1.0" encoding="utf-8"?>
<Project InitialTargets="GenerateCodeFirst">
  <PropertyGroup>
    <CodeGeneratorConfiguration Condition=" '$(CodeGeneratorConfiguration)' == '' ">Debug</CodeGeneratorConfiguration>
    <CodeGenerationOutputPath>$(MSBuildProjectDirectory)\..\CodeGeneration\bin\$(CodeGeneratorConfiguration)\netstandard1.3\</CodeGenerationOutputPath>
  </PropertyGroup>

  <ItemGroup>
    <GeneratorAssemblySearchPaths Include="$(CodeGenerationOutputPath)">
      <Visible>false</Visible>
    </GeneratorAssemblySearchPaths>
  </ItemGroup>
  <ItemGroup>
    <ProjectReference Include="..\CodeGeneration\CodeGeneration.csproj">
      <ReferenceOutputAssembly>false</ReferenceOutputAssembly>
      <SkipGetTargetFrameworkProperties>true</SkipGetTargetFrameworkProperties>
      <UndefineProperties>TargetFramework</UndefineProperties>
      <Properties>Configuration=$(CodeGeneratorConfiguration);Platform=AnyCPU</Properties>
    </ProjectReference>
  </ItemGroup>

  <Target Name="GenerateCodeFirst">
    <PropertyGroup>
      <CoreCompileDependsOn>$(CoreCompileDependsOn);GenerateNativeDllNameCs;GenerateUniqueIdentifierCs</CoreCompileDependsOn>
      <PrepareResourceNamesDependsOn>GenerateCommitIdVersion;$(PrepareResourceNamesDependsOn)</PrepareResourceNamesDependsOn>
      <NativeDllNamePath>$(IntermediateOutputPath)NativeDllName.cs</NativeDllNamePath>
      <UniqueIdentifierPath>$(IntermediateOutputPath)UniqueIdentifier.cs</UniqueIdentifierPath>
      <CommitIdVersionPath>$(IntermediateOutputPath)libgit2sharp_hash.txt</CommitIdVersionPath>
    </PropertyGroup>
  </Target>

  <UsingTask TaskName="GenerateNativeDllNameTask" AssemblyFile="$(CodeGenerationOutputPath)CodeGeneration.dll" />
  <UsingTask TaskName="GenerateUniqueIdentifierTask" AssemblyFile="$(CodeGenerationOutputPath)CodeGeneration.dll" />

  <Target Name="GenerateNativeDllNameCs">
    <GenerateNativeDllNameTask InputHashFile="@(EmbeddedResource)"
                               Condition=" '%(Filename)%(Extension)' == 'libgit2_filename.txt' "
                               OutputFile="$(NativeDllNamePath)" />
    <ItemGroup>
      <Compile Include="$(NativeDllNamePath)" />
      <FileWrites Include="$(NativeDllNamePath)" />
    </ItemGroup>
  </Target>

  <!-- This target runs if any of the projects or .cs files for the project have changed since the last time
      the UniqueIdentifier.cs file was generated. -->
  <Target Name="GenerateUniqueIdentifierCs"
           Inputs="$(MSBuildThisFileFullPath);$(MSBuildAllProjects);@(Compile)"
           Outputs="$(UniqueIdentifierPath)">
    <GenerateUniqueIdentifierTask OutputFile="$(UniqueIdentifierPath)" />
    <ItemGroup>
      <Compile Include="$(UniqueIdentifierPath)" />
      <FileWrites Include="$(UniqueIdentifierPath)" />
    </ItemGroup>
  </Target>

  <Target Name="GenerateCommitIdVersion"
          DependsOnTargets="GetBuildVersion">
    <WriteLinesToFile File="$(CommitIdVersionPath)"
                      Lines="$(GitCommitId)"
                      Overwrite="true" />

    <ItemGroup>
      <EmbeddedResource Include="$(CommitIdVersionPath)">
        <LogicalName>$(RootNamespace).libgit2sharp_hash.txt</LogicalName>
      </EmbeddedResource>
    </ItemGroup>
  </Target>
</Project>
